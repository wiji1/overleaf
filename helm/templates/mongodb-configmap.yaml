apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-init
  namespace: overleaf
  labels:
    app: mongodb
data:
  init-replica-set.sh: |
    #!/bin/bash

    echo "Waiting for MongoDB to start..."
    until mongosh --eval "print(\"MongoDB is ready\")" > /dev/null 2>&1; do
      sleep 2
    done

    echo "Initializing replica set..."
    mongosh --eval "
      rs.initiate({
        _id: '{{ .Values.mongodb.replicaSetName }}',
        members: [
          { _id: 0, host: 'mongodb:27017' }
        ]
      })
    "

    echo "Replica set initialized!"
