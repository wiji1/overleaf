apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-init-replicaset
  namespace: overleaf
  labels:
    app: mongodb
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init-replica-set
          image: mongo:8.0
          command:
            - /bin/bash
            - -c
            - |
              echo "Waiting for MongoDB to be ready..."
              until mongosh --host mongodb --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
                echo "MongoDB not ready yet, waiting..."
                sleep 2
              done

              echo "Checking if replica set is already initialized..."
              RS_STATUS=$(mongosh --host mongodb --quiet --eval "try { rs.status().ok } catch(e) { 0 }")

              if [ "$RS_STATUS" = "1" ]; then
                echo "Replica set already initialized, skipping initialization."
                exit 0
              fi

              echo "Initializing replica set '{{ .Values.mongodb.replicaSetName }}'..."
              mongosh --host mongodb --eval "
                rs.initiate({
                  _id: '{{ .Values.mongodb.replicaSetName }}',
                  members: [
                    { _id: 0, host: 'mongodb:27017' }
                  ]
                })
              "

              echo "Waiting for replica set to elect primary..."
              for i in {1..30}; do
                PRIMARY=$(mongosh --host mongodb --quiet --eval "rs.status().members.find(m => m.state === 1) ? 'true' : 'false'")
                if [ "$PRIMARY" = "true" ]; then
                  echo "Replica set initialized successfully! Primary elected."
                  exit 0
                fi
                echo "Waiting for primary election... (attempt $i/30)"
                sleep 2
              done

              echo "ERROR: Replica set initialization timed out waiting for primary election"
              exit 1
